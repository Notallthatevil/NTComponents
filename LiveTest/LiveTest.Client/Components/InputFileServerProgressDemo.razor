@using Microsoft.AspNetCore.Components.Forms
@using NTComponents

<div style="border:1px solid var(--tnt-color-outline-variant); border-radius:8px; padding:16px; margin-bottom:16px;">
    <h4 style="margin:0 0 8px 0;">@Title</h4>
    <p style="margin:0 0 12px 0; color:var(--tnt-color-on-surface-variant);">
        InteractiveServer mode. No SSE endpoint is used.
    </p>

    <NTInputFile Label="Pick file"
                 SupportingText="@_progressTitle"
                 MaximumFileCount="1"
                 MaximumFileSize="52428800"
                 ShowProgress="true"
                 InputButtonSize="Size.Small"
                 UploadButtonSize="Size.Small"
                 OnUploadButtonClick="OnUploadButtonClickAsync"
                 OnUploadFile="OnUploadFileAsync"
                 OnProgressChanged="OnProgressChangedAsync" />

    <div style="margin-top:12px; font-size:0.95rem;">
        <div><strong>Status:</strong> @_status</div>
        <div><strong>Overall percent:</strong> @_percent%</div>
    </div>
</div>

@code {
    [Parameter]
    public string Title { get; set; } = string.Empty;

    private int _percent;
    private string _progressTitle = "Waiting for upload.";
    private string _status = "Waiting for upload.";

    private Task OnUploadButtonClickAsync(IReadOnlyList<IBrowserFile> _)
        => Task.CompletedTask;

    private async Task OnUploadFileAsync(NTInputFileEventArgs args) {
        if (args.Stream is null) {
            _status = "No upload stream.";
            return;
        }

        _status = "Processing file on server...";
        await InvokeAsync(StateHasChanged);

        var uploadRoot = Path.Combine(AppContext.BaseDirectory, "App_Data", "server-upload-demo");
        Directory.CreateDirectory(uploadRoot);

        var safeName = Path.GetFileName(args.Name);
        var storedName = $"{DateTimeOffset.UtcNow:yyyyMMddHHmmssfff}_{Guid.NewGuid():N}_{safeName}";
        var storedPath = Path.Combine(uploadRoot, storedName);

        await using var output = new FileStream(storedPath, FileMode.CreateNew, FileAccess.Write, FileShare.None, 64 * 1024, FileOptions.Asynchronous | FileOptions.SequentialScan);
        await args.Stream.CopyToAsync(output);

        _status = $"Stored '{safeName}' ({args.Size} bytes).";
    }

    private Task OnProgressChangedAsync(NTInputFileEventArgs args) {
        _percent = args.ProgressPercent;
        _progressTitle = args.ProgressTitle;
        return InvokeAsync(StateHasChanged);
    }
}
