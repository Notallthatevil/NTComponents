@using System.Net.Http.Headers
@using System.Net.Http.Json
@using System.Globalization
@using System.Text
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Forms
@using NTComponents
@inject HttpClient Http

<div style="border:1px solid var(--tnt-color-outline-variant); border-radius:8px; padding:16px; margin-bottom:16px;">
    <h4 style="margin:0 0 8px 0;">@Title</h4>
    <p style="margin:0 0 12px 0; color:var(--tnt-color-on-surface-variant);">
        InteractiveWebAssembly mode. SSE mode: @SseModeLabel
    </p>

    <NTInputFile Label="Pick file"
                 SupportingText="Select a file and click Upload."
                 MaximumFileCount="1"
                 MaximumFileSize="52428800"
                 ShowProgress="true"
                 InputButtonSize="Size.Small"
                 UploadButtonSize="Size.Small"
                 OnUploadButtonClick="OnUploadButtonClickAsync"
                 OnUploadFile="OnUploadFileAsync" />

    <div style="margin-top:12px; font-size:0.95rem;">
        <div><strong>Status:</strong> @_status</div>
        <div><strong>SSE percent:</strong> @_percent%</div>
    </div>
</div>

@code {
    [Parameter]
    public string Title { get; set; } = string.Empty;

    [Parameter]
    public bool UseDotNet10Sse { get; set; }

    private static readonly JsonSerializerOptions _jsonOptions = new() {
        PropertyNameCaseInsensitive = true
    };

    private int _percent;
    private string _status = "Waiting for upload.";

    private string SseModeLabel => GetSseModeLabel();

    private Task OnUploadButtonClickAsync(IReadOnlyList<IBrowserFile> _)
        => Task.CompletedTask;

    private async Task OnUploadFileAsync(NTInputFileEventArgs args) {
        if (args.Stream is null) {
            _status = "No upload stream.";
            return;
        }

        _percent = 0;
        var uploadId = Guid.NewGuid().ToString("N");
        _status = "Starting SSE listener...";

        using var timeout = new CancellationTokenSource(TimeSpan.FromMinutes(2));
        var listenTask = ListenForProgressAsync(uploadId, timeout.Token);

        await Task.Delay(40, timeout.Token);

        using var formData = new MultipartFormDataContent();
        using var fileContent = new StreamContent(args.Stream);
        fileContent.Headers.ContentType = new MediaTypeHeaderValue(string.IsNullOrWhiteSpace(args.ContentType) ? "application/octet-stream" : args.ContentType);
        fileContent.Headers.ContentLength = args.Size;

        formData.Add(new StringContent(uploadId), "uploadId");
        formData.Add(new StringContent(args.Size.ToString(CultureInfo.InvariantCulture)), "fileSize");
        formData.Add(fileContent, "file", args.Name);

        using var response = await Http.PostAsync("api/uploads/process", formData, timeout.Token);
        if (!response.IsSuccessStatusCode) {
            var error = await response.Content.ReadFromJsonAsync<UploadError>(cancellationToken: timeout.Token);
            if (error is null) {
                _status = $"Upload failed: {(int)response.StatusCode}.";
            }
            else if (string.IsNullOrWhiteSpace(error.Code)) {
                _status = error.Message ?? $"Upload failed: {(int)response.StatusCode}.";
            }
            else {
                _status = $"{error.Code}: {error.Message}";
            }
            timeout.Cancel();
            return;
        }

        await listenTask;
        if (!_status.Contains("error", StringComparison.OrdinalIgnoreCase) &&
            !_status.Contains("failed", StringComparison.OrdinalIgnoreCase)) {
            _status = "Upload complete.";
        }
    }

    private async Task ListenForProgressAsync(string uploadId, CancellationToken cancellationToken) {
        try {
            using var request = new HttpRequestMessage(HttpMethod.Get, GetSseEndpointPath(uploadId));
            request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("text/event-stream"));

            using var response = await Http.SendAsync(request, HttpCompletionOption.ResponseHeadersRead, cancellationToken);
            response.EnsureSuccessStatusCode();

            await using var stream = await response.Content.ReadAsStreamAsync(cancellationToken);
            using var reader = new StreamReader(stream);

            var eventType = "message";
            var dataBuilder = new StringBuilder();

            while (!reader.EndOfStream && !cancellationToken.IsCancellationRequested) {
                var line = await reader.ReadLineAsync();
                if (line is null) {
                    break;
                }

                if (line.Length == 0) {
                    if (dataBuilder.Length > 0) {
                        var payload = dataBuilder.ToString().TrimEnd('\n');
                        dataBuilder.Clear();

                        var isDone = await HandleSsePayloadAsync(eventType, payload);
                        if (isDone) {
                            break;
                        }
                    }

                    eventType = "message";
                    continue;
                }

                if (line.StartsWith("event:", StringComparison.Ordinal)) {
                    eventType = line["event:".Length..].Trim();
                }
                else if (line.StartsWith("data:", StringComparison.Ordinal)) {
                    dataBuilder.AppendLine(line["data:".Length..].TrimStart());
                }
            }
        }
        catch (HttpRequestException ex) {
            _status = ex.Message;
            await InvokeAsync(StateHasChanged);
        }
        catch (OperationCanceledException) {
            // Expected on timeout.
        }
    }

    private async Task<bool> HandleSsePayloadAsync(string eventType, string payload) {
        UploadProgressEvent? progress;

        try {
            progress = JsonSerializer.Deserialize<UploadProgressEvent>(payload, _jsonOptions);
        }
        catch (JsonException) {
            return false;
        }

        if (progress is null) {
            return false;
        }

        _percent = progress.Percent;
        _status = string.IsNullOrWhiteSpace(progress.Message)
            ? $"{eventType}: {_percent}%"
            : $"{eventType}: {_percent}% - {progress.Message}";

        await InvokeAsync(StateHasChanged);
        return progress.IsCompleted || progress.IsError;
    }

    private string GetSseEndpointPath(string uploadId) {
#if NET10_0_OR_GREATER
        if (UseDotNet10Sse) {
            return $"api/uploads/progress/{uploadId}/net10";
        }
#endif
        return $"api/uploads/progress/{uploadId}/net9";
    }

    private string GetSseModeLabel() {
#if NET10_0_OR_GREATER
        return UseDotNet10Sse ? ".NET 10 TypedResults.ServerSentEvents" : ".NET 9-compatible manual text/event-stream";
#else
        return ".NET 9-compatible manual text/event-stream";
#endif
    }

    private sealed class UploadProgressEvent {
        public int Percent { get; set; }

        public string? Message { get; set; }

        public bool IsCompleted { get; set; }

        public bool IsError { get; set; }
    }

    private sealed class UploadError {
        public string? Code { get; set; }

        public string? Message { get; set; }
    }
}
